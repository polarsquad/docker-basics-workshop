<!DOCTYPE HTML>

<html>

<head>
	<title>Docker Compose &middot; Docker Basics Workshop</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	
	
	
	<meta http-equiv="content-language" content="en-us" />
	<meta name="generator" content="Hugo 0.74.2" />
	<link rel="stylesheet" href="https://polarsquad.github.io/docker-basics-workshop/css/index.css">
	<link rel="apple-touch-icon" href="https://polarsquad.github.io/docker-basics-workshop/apple-touch-icon.png">
	<link rel="shortcut icon" href="https://polarsquad.github.io/docker-basics-workshop/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
	 crossorigin="anonymous">
</head>
	<body>
		<div class="Wrapper">
			<div class="Container">
				<div class="Header">
  <a href="https://polarsquad.github.io/docker-basics-workshop/">
	<div class="Title center">
		
			<img alt="Docker Basics Workshop Logo" src="https://polarsquad.github.io/docker-basics-workshop/290x132_PolarSquad_logo.png" height="140" />
		
		<span class="text">Docker Basics Workshop</span>
		<span class="subtext"></span>
	</div>
  </a>
</div>

				<div class="Content-wrapper">
					<div class="Sidebar">
	<div class="Menu">
		<div class="item">
			<a href="https://polarsquad.github.io/docker-basics-workshop/">Home</a>
		</div>
		
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/02-preparation/">Preparation</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/03-running-your-first-app/">Running your first Docker app</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/04-managing-containers/">Managing Docker containers</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/05-building-your-first-app/">Building your first Docker app</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/06-publishing-images/">Publishing a Docker image</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/07-volumes/">Mounting files</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/08-docker-networking/">Docker networking</a>
				</div>
			
		
			
				<div class="item">
					<a href="https://polarsquad.github.io/docker-basics-workshop/09-docker-compose/">Docker Compose</a>
				</div>
			
		
			
		
			
		
			
		
	</div>
</div>

					<div class="Content">
						
	<div class="Page" id="">
		<h1>Docker Compose</h1>
		<p>With Docker CLI, we can launch invididual containers.
In this section, we&rsquo;ll cover a few examples on how to launch a fleet of containers using Docker Compose.</p>
<p>Docker Compose is a tool for defining and running multiple containers.
The containers are configured with <a href="https://yaml.org/">YAML</a> formatted files,
and launched with the <code>docker-compose</code> command.</p>
<h2 id="web-app-with-a-database">Web app with a database</h2>
<p>A common use-case for Docker Compose is to use for configuring and launching a quick environment for testing an application you are developing.
For example, if we were to develop a web application that stores data to a database,
then the Docker Compose setup would launch the app and the database the app uses.</p>
<p>Let&rsquo;s extend our web application to support storing data to a <a href="https://redis.io/">Redis</a> database.
Copy and paste this updated source code to the Python app source file we created earlier.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">from</span> redis <span style="color:#ff79c6">import</span> Redis
<span style="color:#ff79c6">from</span> flask <span style="color:#ff79c6">import</span> Flask, request, jsonify
app <span style="color:#ff79c6">=</span> Flask(__name__)

db <span style="color:#ff79c6">=</span> None

@app.route(<span style="color:#f1fa8c">&#39;/&#39;</span>)
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">hello</span>():
    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#39;Hello World!</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>

@app.route(<span style="color:#f1fa8c">&#39;/data&#39;</span>)
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">alldata</span>():
    <span style="color:#ff79c6">return</span> jsonify(db<span style="color:#ff79c6">.</span>hgetall(<span style="color:#f1fa8c">&#39;mydata&#39;</span>))

@app.route(<span style="color:#f1fa8c">&#39;/data/&lt;id&gt;&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>, <span style="color:#f1fa8c">&#39;POST&#39;</span>])
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">data</span>(<span style="color:#8be9fd;font-style:italic">id</span>):
    <span style="color:#ff79c6">if</span> request<span style="color:#ff79c6">.</span>method <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;POST&#39;</span>:
        db<span style="color:#ff79c6">.</span>hset(<span style="color:#f1fa8c">&#39;mydata&#39;</span>, <span style="color:#8be9fd;font-style:italic">id</span>, request<span style="color:#ff79c6">.</span>data)
        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#39;OK</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>
    <span style="color:#ff79c6">return</span> db<span style="color:#ff79c6">.</span>hget(<span style="color:#f1fa8c">&#39;mydata&#39;</span>, <span style="color:#8be9fd;font-style:italic">id</span>)

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
    db <span style="color:#ff79c6">=</span> Redis(
        host<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;REDIS_HOST&#39;</span>),
        port<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">int</span>(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;REDIS_PORT&#39;</span>, <span style="color:#f1fa8c">&#39;6379&#39;</span>)),
        password<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#39;REDIS_PASSWORD&#39;</span>, <span style="color:#f1fa8c">&#39;&#39;</span>),
    )
    app<span style="color:#ff79c6">.</span>run(host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;0.0.0.0&#39;</span>, port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3000</span>)
</code></pre></div><p>The application now has a <code>/data</code> endpoint,
which you can use to insert arbitrary data to a single Redis hash map named <code>mydata</code>.
The Redis connection details are configured using environment variables, which we will cover soon.</p>
<p>Also, we need to update the Dockerfile to include the Redis Python bindings from PIP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#ff79c6">FROM</span><span style="color:#f1fa8c"> ubuntu:18.04</span>
<span style="color:#ff79c6">WORKDIR</span><span style="color:#f1fa8c"> /opt/myapp</span>
<span style="color:#ff79c6">RUN</span> apt-get update <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    apt-get install -y python python-pip <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    pip install --no-cache Flask redis <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    apt-get remove -y python-pip <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    apt-get autoremove -y <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    rm -rf /var/lib/apt/lists/*
<span style="color:#ff79c6">RUN</span> groupadd -g <span style="color:#bd93f9">999</span> appuser <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    useradd -r -u <span style="color:#bd93f9">999</span> -g appuser appuser
<span style="color:#ff79c6">USER</span><span style="color:#f1fa8c"> appuser:appuser</span>
<span style="color:#ff79c6">CMD</span> [<span style="color:#f1fa8c">&#34;python&#34;</span>, <span style="color:#f1fa8c">&#34;app.py&#34;</span>]
<span style="color:#ff79c6">COPY</span> app.py .
</code></pre></div><p>Now that we have our app source code updated,
we can create a Docker Compose file that runs both Redis and our app simultaneously in one script.
Create a file named <code>docker-compose.yml</code> next to the Dockerfile, and insert the following contents.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#39;3&#39;</span>
<span style="color:#ff79c6">services</span>:
  <span style="color:#ff79c6">redis</span>:
    <span style="color:#ff79c6">image</span>: redis
  <span style="color:#ff79c6">myapp</span>:
    <span style="color:#ff79c6">build</span>: .
    <span style="color:#ff79c6">ports</span>:
      - <span style="color:#f1fa8c">&#34;3000:3000&#34;</span>
    <span style="color:#ff79c6">environment</span>:
      <span style="color:#ff79c6">REDIS_HOST</span>: redis
</code></pre></div><p>The file defines two services: <code>redis</code> and <code>myapp</code>.
The Redis service uses <a href="https://hub.docker.com/_/redis">the Redis Docker image from Docker Hub</a>,
which is pre-configured to launch Redis on port 6379.
Our app will be built on-demand when we execute Docker Compose.</p>
<p>The app will expose port 3000 as usual, and it&rsquo;s configured via the environment variables to contact the Redis server listed above.
If we were to run the app container without Docker Compose,
we would supply the environment variables using the <code>-e</code> flag: <code>-e REDIS_HOST=redis</code></p>
<p>Docker Compose automatically creates a dedicated bridge network for the setup.
We could also create custom networks in the Compose file by defining a <code>networks</code> section.</p>
<p>Let&rsquo;s launch the containers with <code>docker-compose</code>.</p>
<pre><code>~/myapp $ docker-compose up -d
</code></pre>
<p>The fleet is launched in the background because we used the <code>-d</code> flag.
If we were to leave it out, the fleet would start in the foreground.</p>
<p>We can test that the setup works by sending some data using <code>curl</code>.</p>
<pre><code>$ curl -X POST -H 'Content-Type: text/plain' -d myvalue http://localhost:3000/data/mykey
OK
$ curl http://localhost:3000/data/mykey
myvalue
$ curl http://localhost:3000/data
{&quot;mykey&quot;:&quot;myvalue&quot;}
</code></pre>
<p>Great! We can now tear down the setup.</p>
<pre><code>~/myapp $ docker-compose down
</code></pre>
<h2 id="integration-tests">Integration tests</h2>
<p>Now that we have a local development environment for our app,
we can extend the setup to run some integration tests for us.</p>
<p>Let&rsquo;s create a shell script that acts as our integration test.
Write the shell script to file <code>integration_test.sh</code> next to the <code>docker-compose.yml</code> file we just created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">#!/usr/bin/env sh
</span><span style="color:#ff79c6"></span><span style="color:#8be9fd;font-style:italic">set</span> -e <span style="color:#6272a4"># Fail script on command error</span>

<span style="color:#8be9fd;font-style:italic">APP_URL</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://</span><span style="color:#8be9fd;font-style:italic">$APP_HOST</span><span style="color:#f1fa8c">:</span><span style="color:#8be9fd;font-style:italic">$APP_PORT</span><span style="color:#f1fa8c">&#34;</span>

<span style="color:#6272a4"># Poll server until it&#39;s ready</span>
<span style="color:#ff79c6">while</span> true; <span style="color:#ff79c6">do</span>
    <span style="color:#ff79c6">if</span> curl -sfL <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$APP_URL</span><span style="color:#f1fa8c">&#34;</span> &gt;/dev/null; <span style="color:#ff79c6">then</span>
        <span style="color:#8be9fd;font-style:italic">break</span>
    <span style="color:#ff79c6">fi</span>
<span style="color:#ff79c6">done</span>

<span style="color:#6272a4"># Test</span>
<span style="color:#8be9fd;font-style:italic">EXPECTED</span><span style="color:#ff79c6">=</span>mytestvalue
curl -sfL -X POST -H <span style="color:#f1fa8c">&#39;Content-Type: text/plain&#39;</span> -d <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$EXPECTED</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$APP_URL</span><span style="color:#f1fa8c">/data/mytestkey&#34;</span>
<span style="color:#8be9fd;font-style:italic">ACTUAL</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>curl -sfL <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$APP_URL</span><span style="color:#f1fa8c">/data/mytestkey&#34;</span><span style="color:#ff79c6">)</span>

<span style="color:#6272a4"># Check result</span>
<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$ACTUAL</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$EXPECTED</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">]</span>; <span style="color:#ff79c6">then</span>
    <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;Test success!&#34;</span>
<span style="color:#ff79c6">else</span>
    <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;Test failed! </span><span style="color:#8be9fd;font-style:italic">$ACTUAL</span><span style="color:#f1fa8c"> != </span><span style="color:#8be9fd;font-style:italic">$EXPECTED</span><span style="color:#f1fa8c">&#34;</span>
    <span style="color:#8be9fd;font-style:italic">exit</span> <span style="color:#bd93f9">1</span>
<span style="color:#ff79c6">fi</span>
</code></pre></div><p>Make sure the script is executable:</p>
<pre><code>~/myapp $ chmod +x integration_test.sh
</code></pre>
<p>In the script above, we insert a value using the app <code>/data</code> endpoint, read it back, and verify that what we read is what we wrote.
If the test fails, the script exits with an error code. Otherwise, the script will exit normally.
Normally, you&rsquo;d most likely want to use a proper test framework, but this should be enough for this exercise.</p>
<p>Before the test is executed, the script polls the server until it can contact it.
This is done to avoid race conditions because Docker Compose launches all the containers simultaneously.</p>
<p>Now we need to have this script executed as part of the Docker Compose setup.
Instead of extending the existing <code>docker-compose.yml</code> file,
we&rsquo;ll create a another similar file that contains only the test.
We&rsquo;ll later merge the two compose files together.
Create a file named <code>docker-compose-test.yml</code> next to the <code>docker-compose.yml</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#39;3&#39;</span>
<span style="color:#ff79c6">services</span>:
  <span style="color:#ff79c6">mytest</span>:
    <span style="color:#ff79c6">image</span>: appropriate/curl
    <span style="color:#ff79c6">entrypoint</span>:
      - /integration_test.sh
    <span style="color:#ff79c6">command</span>: []
    <span style="color:#ff79c6">environment</span>:
      <span style="color:#ff79c6">APP_HOST</span>: myapp
      <span style="color:#ff79c6">APP_PORT</span>: <span style="color:#bd93f9">3000</span>
    <span style="color:#ff79c6">volumes</span>:
      - ./integration_test.sh:/integration_test.sh
</code></pre></div><p>For running the test, we&rsquo;ll use the <code>appropriate/curl</code> image from the earlier exercise.
The test script will be brought in as a volume, and the configuration details via environment variables.</p>
<p>Since the <code>appropriate/curl</code> image uses <code>curl</code> as the entrypoint program,
we cannot launch the script by overriding the command.
Instead, we&rsquo;ll need to override the entrypoint with our test script.</p>
<p>When we run Docker Compose, we can use the <code>-f</code> option multiple times to provide custom Docker Compose scripts.
This will combine the scripts to one script before it&rsquo;s run.</p>
<p>We can use the flag <code>--abort-on-container-exit</code> to cause the entire setup to tear down automatically when any of the containers exit.
This way the test script can automatically cause the setup to be torn down when it exits.
Moreover, the exit code from the first container to exit will be the exit code for <code>docker-compose</code>,
which we can use to determine whether the test was successful or not.</p>
<p>Let&rsquo;s run the test Docker Compose script in combination with the existing Docker Compose script.</p>
<pre><code>$ docker-compose -f docker-compose.yml -f docker-compose-test.yml up --abort-on-container-exit
$ echo $?
0
</code></pre>
<p>If the test succeeded, the exit code should be <code>0</code>.
Try editing the integration test script to cause the test to fail, and re-run the Docker Compose command.</p>
</div>

						<div class="Footer">
	<p>Made with ❤️ for Developers by Polar Squad. Content on this site is licensed under a Creative Commons license</p>
</div>
<script src="https://polarsquad.github.io/docker-basics-workshop/js/index.js"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-xxxx-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

					</div>
				</div>
		</div>
	</body>
</html>
